<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Bridge Clearance</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --ocean-dark: #0A1628;
            --ocean-mid: #1B3A5F;
            --ocean-light: #2E5C8A;
            --sky-light: #5BA3D0;
            --sky-bright: #8EC5E8;
            --foam: #B8E6F9;
            --sand: #F4E8D8;
            --sunset: #FF6B6B;
            --sunrise: #FFD93D;
            --mint: #6BCF7F;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background: linear-gradient(135deg, var(--ocean-dark) 0%, var(--ocean-mid) 50%, var(--ocean-light) 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(91, 163, 208, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(142, 197, 232, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(107, 207, 127, 0.05) 0%, transparent 50%);
            animation: drift 20s ease-in-out infinite alternate;
            pointer-events: none;
        }

        @keyframes drift {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(10px, 10px) scale(1.05); }
        }

        .app-container {
            max-width: 440px;
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        .hero-header {
            padding: 40px 24px 32px;
            text-align: center;
            position: relative;
        }

        .hero-icon {
            font-size: 72px;
            margin-bottom: 16px;
            display: inline-block;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.3));
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }

        .hero-title {
            font-size: 42px;
            font-weight: 800;
            letter-spacing: -1px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #FFFFFF 0%, var(--foam) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero-subtitle {
            font-size: 18px;
            opacity: 0.85;
            font-weight: 500;
            letter-spacing: 0.3px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            border-radius: 24px;
            margin: 0 16px 20px;
            padding: 24px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 12px 48px rgba(0, 0, 0, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        }

        .card-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.05) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.3px;
        }

        .span-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .span-option {
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 28px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .span-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .span-option:hover::before {
            opacity: 1;
        }

        .span-option.selected {
            background: linear-gradient(135deg, var(--sky-bright) 0%, var(--sky-light) 100%);
            border-color: var(--foam);
            box-shadow: 0 8px 24px rgba(91, 163, 208, 0.4);
        }

        .span-option.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 12px;
            right: 12px;
            width: 26px;
            height: 26px;
            background: rgba(255, 255, 255, 0.95);
            color: var(--sky-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 900;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .span-label {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .span-option.selected .span-label {
            opacity: 1;
            color: white;
        }

        .span-value {
            font-size: 36px;
            font-weight: 900;
            letter-spacing: -1px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-wrapper {
            position: relative;
        }

        input[type="date"],
        input[type="time"],
        input[type="number"] {
            width: 100%;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1.5px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            color: white;
            font-size: 18px;
            font-weight: 500;
            font-family: inherit;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* FIXED: Better time input support for Safari */
        input[type="time"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            min-height: 52px;
        }

        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1) brightness(1.5);
            cursor: pointer;
            opacity: 1;
            font-size: 24px;
            padding: 8px;
            margin-left: 8px;
        }

        input[type="date"]::-webkit-datetime-edit,
        input[type="time"]::-webkit-datetime-edit {
            color: white;
            padding: 0;
        }

        input[type="date"]::-webkit-datetime-edit-fields-wrapper,
        input[type="time"]::-webkit-datetime-edit-fields-wrapper {
            color: white;
            padding: 0;
        }

        input[type="time"]::-webkit-datetime-edit-hour-field,
        input[type="time"]::-webkit-datetime-edit-minute-field,
        input[type="time"]::-webkit-datetime-edit-ampm-field {
            color: white;
            padding: 2px 4px;
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--foam);
            box-shadow: 0 0 0 4px rgba(184, 230, 249, 0.15);
        }

        .input-unit {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            font-weight: 600;
            opacity: 0.6;
            pointer-events: none;
        }

        .input-hint {
            font-size: 13px;
            margin-top: 8px;
            opacity: 0.6;
            line-height: 1.4;
        }

        .info-panel {
            background: rgba(107, 207, 127, 0.15);
            border: 1px solid rgba(107, 207, 127, 0.3);
            border-radius: 16px;
            padding: 16px;
            margin-top: 16px;
            backdrop-filter: blur(10px);
        }

        .info-text {
            font-size: 14px;
            line-height: 1.6;
            opacity: 0.9;
        }

        .info-text strong {
            font-weight: 700;
            opacity: 1;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding: 0 16px 24px;
        }

        .btn {
            padding: 18px 28px;
            border-radius: 18px;
            border: none;
            font-size: 17px;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.3px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .btn:hover::before {
            opacity: 1;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--sunrise) 0%, #FFC947 100%);
            color: var(--ocean-dark);
            box-shadow: 0 8px 24px rgba(255, 217, 61, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1.5px solid rgba(255, 255, 255, 0.3);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 22, 40, 0.95);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .loading-content {
            text-align: center;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--foam);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            font-weight: 600;
            opacity: 0.9;
        }

        .toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 24px;
            border-radius: 16px;
            font-size: 15px;
            font-weight: 600;
            z-index: 1001;
            animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 90%;
            text-align: center;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .toast-success {
            background: rgba(107, 207, 127, 0.95);
            color: white;
        }

        .toast-error {
            background: rgba(255, 107, 107, 0.95);
            color: white;
        }

        .result-card {
            margin: 0 16px 20px;
            border-radius: 28px;
            overflow: hidden;
            animation: scaleIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .result-hero {
            padding: 48px 32px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .result-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .result-hero.safe {
            background: linear-gradient(135deg, var(--mint) 0%, #4DB65D 100%);
        }

        .result-hero.warning {
            background: linear-gradient(135deg, var(--sunrise) 0%, #FFB340 100%);
        }

        .result-hero.danger {
            background: linear-gradient(135deg, var(--sunset) 0%, #E84855 100%);
        }

        .result-icon {
            font-size: 80px;
            margin-bottom: 16px;
            filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.3));
            position: relative;
            z-index: 1;
        }

        .result-status {
            font-size: 32px;
            font-weight: 900;
            margin-bottom: 12px;
            letter-spacing: -0.5px;
            position: relative;
            z-index: 1;
        }

        .result-message {
            font-size: 16px;
            opacity: 0.95;
            line-height: 1.5;
            position: relative;
            z-index: 1;
        }

        .result-body {
            background: rgba(255, 255, 255, 0.98);
            color: var(--ocean-dark);
            padding: 32px 28px;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        }

        .result-row:last-child {
            border-bottom: none;
        }

        .result-label {
            font-size: 15px;
            opacity: 0.7;
            font-weight: 500;
        }

        .result-value {
            font-size: 16px;
            font-weight: 700;
        }

        .clearance-box {
            background: linear-gradient(135deg, rgba(107, 207, 127, 0.15) 0%, rgba(91, 163, 208, 0.15) 100%);
            border-radius: 20px;
            padding: 24px;
            text-align: center;
            margin: 24px 0;
        }

        .clearance-label {
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
            opacity: 0.6;
            margin-bottom: 8px;
        }

        .clearance-value {
            font-size: 56px;
            font-weight: 900;
            letter-spacing: -2px;
            line-height: 1;
        }

        .clearance-value.positive {
            color: var(--mint);
        }

        .clearance-value.negative {
            color: var(--sunset);
        }

        .progress-section {
            margin-top: 24px;
        }

        .progress-bar {
            height: 12px;
            background: rgba(0, 0, 0, 0.08);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(200%); }
        }

        .progress-fill.safe {
            background: linear-gradient(90deg, var(--mint) 0%, #4DB65D 100%);
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, var(--sunrise) 0%, #FFB340 100%);
        }

        .progress-fill.danger {
            background: linear-gradient(90deg, var(--sunset) 0%, #E84855 100%);
        }

        .progress-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 13px;
            font-weight: 600;
            opacity: 0.7;
        }

        .windows-container {
            padding: 0 16px 24px;
        }

        .windows-header {
            margin-bottom: 20px;
        }

        .windows-title {
            font-size: 28px;
            font-weight: 900;
            letter-spacing: -0.5px;
            margin-bottom: 4px;
        }

        .time-window {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            border-radius: 20px;
            padding: 20px 24px;
            margin-bottom: 16px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        .window-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        }

        .window-time-range {
            flex: 1;
        }

        .window-time {
            font-size: 22px;
            font-weight: 800;
            letter-spacing: -0.3px;
            margin-bottom: 4px;
        }

        .window-duration {
            font-size: 13px;
            opacity: 0.7;
            font-weight: 500;
        }

        .window-min-badge {
            background: linear-gradient(135deg, var(--mint) 0%, #4DB65D 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 800;
            box-shadow: 0 4px 12px rgba(107, 207, 127, 0.4);
            text-align: center;
            min-width: 80px;
        }

        .badge-label {
            font-size: 10px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .badge-value {
            font-size: 18px;
            font-weight: 900;
        }

        .window-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .detail-box {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 12px;
        }

        .detail-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.6;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .detail-value {
            font-size: 16px;
            font-weight: 700;
        }

        .detail-subtext {
            font-size: 12px;
            opacity: 0.6;
            margin-top: 2px;
        }

        .no-times-card {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 24px;
            padding: 40px 28px;
            margin: 0 16px 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(255, 107, 107, 0.2);
        }

        .no-times-icon {
            font-size: 72px;
            margin-bottom: 20px;
        }

        .no-times-title {
            font-size: 26px;
            font-weight: 900;
            margin-bottom: 12px;
            letter-spacing: -0.5px;
        }

        .no-times-message {
            font-size: 16px;
            opacity: 0.85;
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .suggestions {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            text-align: left;
        }

        .suggestions-title {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            opacity: 0.7;
        }

        .suggestion {
            font-size: 15px;
            padding: 10px 0;
            padding-left: 24px;
            position: relative;
            line-height: 1.5;
        }

        .suggestion::before {
            content: 'â†’';
            position: absolute;
            left: 0;
            font-weight: 900;
            color: var(--foam);
        }

        .validation-badge {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(107, 207, 127, 0.95);
            color: white;
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            z-index: 100;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .debug-info {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 12px;
            margin-top: 16px;
            font-size: 11px;
            font-family: monospace;
            color: rgba(255, 255, 255, 0.7);
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="hero-header">
            <div class="hero-icon">â›µ</div>
            <h1 class="hero-title">Bridge Clearance</h1>
            <p class="hero-subtitle">Tamaki Drive Â· Auckland</p>
        </div>

        <div class="glass-card">
            <div class="card-header">
                <div class="card-icon">ðŸŒ‰</div>
                <h2 class="card-title">Select Bridge Span</h2>
            </div>
            <div class="span-grid">
                <div class="span-option selected" onclick="selectSpan('in-out', 6.2)">
                    <div class="span-label">In/Out</div>
                    <div class="span-value">6.2m</div>
                </div>
                <div class="span-option" onclick="selectSpan('high', 6.5)">
                    <div class="span-label">High</div>
                    <div class="span-value">6.5m</div>
                </div>
            </div>
            <div class="info-panel">
                <p class="info-text"><strong>Chart Datum:</strong> Clearance measured at lowest astronomical tide. Actual clearance decreases as tide rises.</p>
            </div>
        </div>

        <div class="glass-card">
            <div class="card-header">
                <div class="card-icon">ðŸ“…</div>
                <h2 class="card-title">When are you traveling?</h2>
            </div>
            <div class="form-group">
                <label class="form-label">Date</label>
                <input type="date" id="tideDate">
            </div>
            <div class="form-group">
                <label class="form-label">Time (Optional)</label>
                <input type="time" id="preferredTime" step="900">
                <p class="input-hint">Leave blank to see all safe passage windows</p>
            </div>
        </div>

        <div class="glass-card">
            <div class="card-header">
                <div class="card-icon">â›µ</div>
                <h2 class="card-title">Your Boat</h2>
            </div>
            <div class="form-group">
                <label class="form-label">Height from Waterline</label>
                <div class="input-wrapper">
                    <input type="number" id="boatHeight" step="0.1" placeholder="4.5">
                    <span class="input-unit">m</span>
                </div>
                <p class="input-hint">To highest point (mast, antenna, etc.) when unladen</p>
            </div>
            <div class="form-group">
                <label class="form-label">Safety Margin</label>
                <div class="input-wrapper">
                    <input type="number" id="safetyMargin" step="0.1" value="0.5">
                    <span class="input-unit">m</span>
                </div>
                <p class="input-hint">Recommended minimum clearance above boat</p>
            </div>
        </div>

        <div id="loading" class="loading-overlay hidden">
            <div class="loading-content">
                <div class="spinner"></div>
                <p class="loading-text">Loading tide data...</p>
            </div>
        </div>

        <div id="toastContainer"></div>
        <div id="resultContainer"></div>

        <div class="button-group">
            <button class="btn btn-secondary" onclick="checkClearance()">Check Now</button>
            <button class="btn btn-primary" onclick="findBestTimes()">Find Times</button>
        </div>
    </div>

    <div class="validation-badge">âœ“ Fixed v2.0</div>

    <script>
        let selectedSpanClearance = 6.2;
        let selectedSpanName = 'IN/OUT';
        let tideData = [];
        let fullDayTideData = [];

        document.getElementById('tideDate').valueAsDate = new Date();

        function selectSpan(spanType, clearance) {
            selectedSpanClearance = clearance;
            selectedSpanName = spanType === 'high' ? 'HIGH' : 'IN/OUT';
            
            document.querySelectorAll('.span-option').forEach((card, index) => {
                if ((spanType === 'in-out' && index === 0) || (spanType === 'high' && index === 1)) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1) reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        async function loadTideData() {
            const dateInput = document.getElementById('tideDate').value;
            
            if (!dateInput) {
                showToast('Please select a date', 'error');
                return false;
            }

            const loading = document.getElementById('loading');
            loading.classList.remove('hidden');
            document.getElementById('resultContainer').innerHTML = '';

            try {
                const selectedDate = new Date(dateInput + 'T00:00:00');
                const year = selectedDate.getFullYear();
                
                if (year < 2024 || year > 2028) {
                    throw new Error('Tide data only available for 2024-2028');
                }
                
                const csvUrl = `https://static.charts.linz.govt.nz/tide-tables/maj-ports/csv/Auckland%20${year}.csv`;
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(csvUrl)}`;
                
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error('Failed to fetch tide data');
                
                const csvText = await response.text();
                tideData = parseLinzCsv(csvText, selectedDate);
                fullDayTideData = generateHourlyTideData(tideData, selectedDate);
                
                if (tideData.length === 0) {
                    throw new Error('No tide data found for selected date');
                }
                
                console.log('Tide data loaded:', tideData.length, 'points');
                console.log('Hourly data:', fullDayTideData.length, 'points');
                
                showToast('Tide data loaded successfully', 'success');
                return true;
                
            } catch (error) {
                showToast(error.message, 'error');
                console.error('Load error:', error);
                return false;
            } finally {
                loading.classList.add('hidden');
            }
        }

        function parseLinzCsv(csvText, targetDate) {
            const lines = csvText.trim().split('\n');
            const data = [];
            
            // Normalize target date to just the date part for comparison
            const targetDateStr = targetDate.toISOString().split('T')[0];
            
            for (let i = 2; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const parts = line.split(',');
                if (parts.length < 6) continue;
                
                const day = parseInt(parts[0]);
                const month = parseInt(parts[2]);
                const year = parseInt(parts[3]);
                
                const lineDate = new Date(year, month - 1, day);
                const lineDateStr = lineDate.toISOString().split('T')[0];
                
                if (lineDateStr !== targetDateStr) continue;
                
                for (let j = 0; j < 4; j++) {
                    const timeIdx = 4 + j * 2;
                    const heightIdx = 5 + j * 2;
                    
                    if (timeIdx >= parts.length || heightIdx >= parts.length) break;
                    
                    const timeStr = parts[timeIdx].trim();
                    const heightStr = parts[heightIdx].trim();
                    if (!timeStr || !heightStr) continue;
                    
                    const [hours, minutes] = timeStr.split(':').map(Number);
                    const tideTime = new Date(year, month - 1, day, hours, minutes);
                    const height = parseFloat(heightStr);
                    
                    data.push({ time: tideTime, height: height });
                }
            }
            
            return data;
        }

        function generateHourlyTideData(tidePoints, date) {
            if (tidePoints.length < 2) return tidePoints;
            
            const hourlyData = [];
            const year = date.getFullYear();
            const month = date.getMonth();
            const day = date.getDate();
            
            for (let hour = 0; hour < 24; hour++) {
                const currentTime = new Date(year, month, day, hour, 0, 0);
                
                let before = null, after = null;
                for (let i = 0; i < tidePoints.length - 1; i++) {
                    if (tidePoints[i].time <= currentTime && tidePoints[i + 1].time >= currentTime) {
                        before = tidePoints[i];
                        after = tidePoints[i + 1];
                        break;
                    }
                }
                
                if (!before || !after) {
                    const nearest = tidePoints.reduce((prev, curr) => 
                        Math.abs(curr.time - currentTime) < Math.abs(prev.time - currentTime) ? curr : prev
                    );
                    hourlyData.push({ time: currentTime, height: nearest.height });
                } else {
                    const timeDiff = after.time - before.time;
                    const timeFromBefore = currentTime - before.time;
                    const ratio = timeFromBefore / timeDiff;
                    const interpolatedHeight = before.height + (after.height - before.height) * ratio;
                    hourlyData.push({ time: currentTime, height: interpolatedHeight });
                }
            }
            
            return hourlyData;
        }

        async function checkClearance() {
            const boatHeight = parseFloat(document.getElementById('boatHeight').value);
            const safetyMargin = parseFloat(document.getElementById('safetyMargin').value);
            const preferredTime = document.getElementById('preferredTime').value;

            if (isNaN(boatHeight) || isNaN(safetyMargin)) {
                showToast('Please enter boat height and safety margin', 'error');
                return;
            }

            if (fullDayTideData.length === 0) {
                const success = await loadTideData();
                if (!success) return;
            }

            if (!preferredTime || preferredTime.trim() === '') {
                showToast('Please enter your preferred travel time', 'error');
                return;
            }

            // CRITICAL FIX: Properly parse the time input every time
            const dateInput = document.getElementById('tideDate').value;
            const selectedDate = new Date(dateInput + 'T00:00:00');
            const [hours, minutes] = preferredTime.split(':').map(Number);
            const targetTime = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), hours, minutes, 0);

            console.log('Check clearance for:', targetTime.toISOString());

            // CRITICAL FIX: Use the CURRENT targetTime, not a cached one
            const closestTide = fullDayTideData.reduce((prev, curr) => 
                Math.abs(curr.time.getTime() - targetTime.getTime()) < Math.abs(prev.time.getTime() - targetTime.getTime()) ? curr : prev
            );

            console.log('Closest tide:', closestTide.time.toISOString(), closestTide.height);

            displayResult(boatHeight, safetyMargin, closestTide, targetTime);
        }

        function displayResult(boatHeight, safetyMargin, tide, requestedTime) {
            const actualClearance = selectedSpanClearance - tide.height;
            const clearanceNeeded = boatHeight + safetyMargin;
            const spareClearance = actualClearance - clearanceNeeded;

            let status, statusClass, icon, message;

            if (spareClearance >= 0.5) {
                status = 'Safe to Pass';
                statusClass = 'safe';
                icon = 'âœ“';
                message = 'You have sufficient clearance to pass safely at this time.';
            } else if (spareClearance >= 0) {
                status = 'Proceed with Caution';
                statusClass = 'warning';
                icon = 'âš ';
                message = 'Clearance is minimal. Proceed with extreme caution.';
            } else {
                status = 'Do Not Pass';
                statusClass = 'danger';
                icon = 'âœ•';
                message = 'Insufficient clearance. Wait for lower tide.';
            }

            const percentage = Math.min(100, Math.max(0, (clearanceNeeded / actualClearance) * 100));
            const requestedTimeStr = requestedTime.toLocaleTimeString('en-NZ', { hour: '2-digit', minute: '2-digit' });
            const tideTimeStr = tide.time.toLocaleTimeString('en-NZ', { hour: '2-digit', minute: '2-digit' });

            document.getElementById('resultContainer').innerHTML = `
                <div class="result-card">
                    <div class="result-hero ${statusClass}">
                        <div class="result-icon">${icon}</div>
                        <div class="result-status">${status}</div>
                        <div class="result-message">${message}</div>
                    </div>
                    <div class="result-body">
                        <div class="result-row">
                            <span class="result-label">Bridge Span</span>
                            <span class="result-value">${selectedSpanName} (${selectedSpanClearance.toFixed(1)}m)</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Requested Time</span>
                            <span class="result-value">${requestedTimeStr}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Tide Data Time</span>
                            <span class="result-value">${tideTimeStr}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Tide Height</span>
                            <span class="result-value">${tide.height.toFixed(2)}m</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Actual Clearance</span>
                            <span class="result-value">${actualClearance.toFixed(2)}m</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Required</span>
                            <span class="result-value">${clearanceNeeded.toFixed(2)}m</span>
                        </div>
                        
                        <div class="clearance-box">
                            <div class="clearance-label">Spare Clearance</div>
                            <div class="clearance-value ${spareClearance >= 0 ? 'positive' : 'negative'}">
                                ${spareClearance >= 0 ? '+' : ''}${spareClearance.toFixed(2)}m
                            </div>
                        </div>

                        <div class="progress-section">
                            <div class="progress-bar">
                                <div class="progress-fill ${statusClass}" style="width: ${percentage}%"></div>
                            </div>
                            <div class="progress-labels">
                                <span>Clearance Used</span>
                                <span>${Math.min(100, percentage).toFixed(0)}%</span>
                            </div>
                        </div>

                        <div class="info-panel" style="margin-top: 24px;">
                            <p class="info-text"><strong>Weather Impact:</strong> Barometric pressure and wind can affect tide height. Add extra margin in adverse conditions.</p>
                        </div>

                        <div class="debug-info">
                            Debug: Date=${tide.time.toISOString().split('T')[0]} | 
                            Requested=${requestedTime.toISOString()} | 
                            Matched=${tide.time.toISOString()}
                        </div>
                    </div>
                </div>
            `;
        }

        async function findBestTimes() {
            const boatHeight = parseFloat(document.getElementById('boatHeight').value);
            const safetyMargin = parseFloat(document.getElementById('safetyMargin').value);

            if (isNaN(boatHeight) || isNaN(safetyMargin)) {
                showToast('Please enter boat height and safety margin', 'error');
                return;
            }

            if (fullDayTideData.length === 0) {
                const success = await loadTideData();
                if (!success) return;
            }

            const clearanceNeeded = boatHeight + safetyMargin;
            const safeWindows = [];
            
            for (let tide of fullDayTideData) {
                const actualClearance = selectedSpanClearance - tide.height;
                const spareClearance = actualClearance - clearanceNeeded;
                if (spareClearance >= 0) {
                    safeWindows.push({ 
                        time: tide.time, 
                        tideHeight: tide.height,
                        actualClearance: actualClearance,
                        spareClearance: spareClearance 
                    });
                }
            }

            const windows = [];
            let currentWindow = null;
            
            for (let i = 0; i < safeWindows.length; i++) {
                const safe = safeWindows[i];
                
                if (!currentWindow) {
                    currentWindow = { 
                        start: safe, 
                        end: safe,
                        minClearance: safe.spareClearance,
                        maxClearance: safe.spareClearance
                    };
                } else {
                    const hoursDiff = (safe.time - currentWindow.end.time) / (1000 * 60 * 60);
                    
                    if (hoursDiff <= 1.5) {
                        currentWindow.end = safe;
                        currentWindow.minClearance = Math.min(currentWindow.minClearance, safe.spareClearance);
                        currentWindow.maxClearance = Math.max(currentWindow.maxClearance, safe.spareClearance);
                    } else {
                        windows.push(currentWindow);
                        currentWindow = { 
                            start: safe, 
                            end: safe,
                            minClearance: safe.spareClearance,
                            maxClearance: safe.spareClearance
                        };
                    }
                }
            }
            
            if (currentWindow) windows.push(currentWindow);
            displayBestTimes(windows, clearanceNeeded);
        }

        function displayBestTimes(windows, clearanceNeeded) {
            const container = document.getElementById('resultContainer');
            
            if (windows.length === 0) {
                container.innerHTML = `
                    <div class="no-times-card">
                        <div class="no-times-icon">ðŸ›‘</div>
                        <div class="no-times-title">No Safe Passage Times</div>
                        <div class="no-times-message">
                            Your boat requires ${clearanceNeeded.toFixed(1)}m clearance. 
                            The ${selectedSpanName} span (${selectedSpanClearance.toFixed(1)}m) 
                            cannot accommodate this on the selected date.
                        </div>
                        <div class="suggestions">
                            <div class="suggestions-title">Try These Options</div>
                            <div class="suggestion">Select a different date with lower tides</div>
                            <div class="suggestion">Use the HIGH span if currently using IN/OUT</div>
                            <div class="suggestion">Reduce safety margin (not recommended)</div>
                            <div class="suggestion">Consider an alternative route</div>
                        </div>
                    </div>
                `;
                return;
            }

            const windowsHTML = windows.map((window, idx) => {
                const duration = (window.end.time - window.start.time) / (1000 * 60 * 60);
                const startStr = window.start.time.toLocaleTimeString('en-NZ', { hour: '2-digit', minute: '2-digit' });
                const endStr = window.end.time.toLocaleTimeString('en-NZ', { hour: '2-digit', minute: '2-digit' });
                const tideDirection = window.end.tideHeight > window.start.tideHeight ? 'â†— Rising' : 'â†˜ Falling';
                
                return `
                    <div class="time-window">
                        <div class="window-header">
                            <div class="window-time-range">
                                <div class="window-time">${startStr} â€“ ${endStr}</div>
                                <div class="window-duration">${Math.round(duration)}h window ${tideDirection}</div>
                            </div>
                            <div class="window-min-badge">
                                <div class="badge-label">Min</div>
                                <div class="badge-value">+${window.minClearance.toFixed(2)}m</div>
                            </div>
                        </div>
                        <div class="window-details">
                            <div class="detail-box">
                                <div class="detail-label">Window Start</div>
                                <div class="detail-value">+${window.start.spareClearance.toFixed(2)}m</div>
                                <div class="detail-subtext">Tide: ${window.start.tideHeight.toFixed(2)}m</div>
                            </div>
                            <div class="detail-box">
                                <div class="detail-label">Window End</div>
                                <div class="detail-value">+${window.end.spareClearance.toFixed(2)}m</div>
                                <div class="detail-subtext">Tide: ${window.end.tideHeight.toFixed(2)}m</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div class="windows-container">
                    <div class="windows-header">
                        <div class="windows-title">${windows.length} Safe ${windows.length === 1 ? 'Window' : 'Windows'}</div>
                    </div>
                    ${windowsHTML}
                    <div class="info-panel">
                        <p class="info-text"><strong>Understanding the Data:</strong> "Min" shows minimum clearance during the window. Start/End values show spare clearance at each time. Choose times with higher clearance for maximum safety.</p>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
